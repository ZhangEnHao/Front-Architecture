## 重绘（Repaint）和回流（Reflow）

- 重绘是当节点需要更改外观而不会影响布局的，比如改变 color 就叫称为重绘

对 DOM 的修改导致了样式的变化、却并未影响其几何属性（比如修改了颜色或背景色）时，浏览器不需重新计算元素的几何属性、直接为该元素绘制新的样式（跳过了上图所示的回流环节）。

- 回流是布局或者几何属性需要改变就称为回流。

对 DOM 的修改引发了 DOM 几何尺寸的变化（比如修改元素的宽、高或隐藏元素等）时，浏览器需要重新计算元素的几何属性（其他元素的几何属性和位置也会因此受到影响），然后再将计算的结果绘制出来，这个过程就是回流（也叫重排）。

回流必定会发生重绘，重绘不一定会引发回流。回流所需的成本比重绘高的多，改变深层次的节点很可能导致父节点的一系列回流。

1. 常见引起回流属性和方法

任何会改变元素几何信息 (元素的位置和尺寸大小) 的操作，都会触发回流，

- 添加或者删除 可见的 DOM 元素 / 样式；

- 元素尺寸改变 —— 边距、填充、边框、宽度和高度；

- 内容变化，比如用户在 input 框中输入文字；

- 修改浏览器窗口尺寸时（即 resize 事件发生时，移动端没有这个问题），或是滚动的时候，**有可能**会触发（具体要看浏览器的规则）；

- 计算 offsetWidth 和 offsetHeight 属性；

- 设置 style 属性的值；

- 改变 window 大小 / 字体 / 文字；

- 定位或者浮动

- 修改网页的默认字体时（这个很消耗性能）；

- display: none；

2. 常见引起重绘属性和方法

- color

- border-style

- visibility

- background

- outline

## 减少重绘和回流，避免布局抖动（layout thrashing）

如果页面经常需要做重绘和回流，就很容易导致“页面抖动”。所以要减少重绘和回流。

1. 使用 `transfrom:translate`让元素做位移

比如说，如果想改变一个元素的位置，很多人可能会使用相对布局的 left、top 属性，但是这个属性会引起回流。我们可以使用 `transfrom:translate` 让元素做位移，这个属性既不会触发回流，也不会触发 重绘，只会触发合成 conmposite。

2. 把 DOM 离线后修改

比如：先把 DOM 给 display:none (有一次 Reflow)，然后你修改 100 次，然后再把它显示出来；

再比如说，vue、react 这样的框架，采用了虚拟 DOM，它会把涉及到 DOM 修改的操作积攒起来，然后统一计算，批量处理，最后应用到真正的 DOM 上。

3. 读写分离。建议先批量读，然后再批量做写操作。

不要把节点的属性值放在一个循环里当成循环里的变量。可以使用 [FastDom](https://github.com/wilsonpage/fastdom) 批量对 DOM 进行读写操作。

[FastDom](https://github.com/wilsonpage/fastdom) 是用于做防抖的一个比较流行的解决方案。

4. 使用 `visibility` 替换 `display: none` ，因为前者只会引起重绘，后者会引发回流（改变了布局）。

5. 不要使用 table 布局，可能很小的一个小改动会造成整个 table 的重新布局。

6. 动画实现的速度的选择，动画速度越快，回流次数越多，也可以选择使用 `requestAnimationFrame`。

7. 将频繁重绘或者回流的节点设置为图层，图层能够阻止该节点的渲染行为影响别的节点。比如对于 video 标签来说，浏览器会自动将该节点变为图层。
